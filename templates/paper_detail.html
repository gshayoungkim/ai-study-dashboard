{% extends "base.html" %}
{% block title %}ë…¼ë¬¸ ìƒì„¸{% endblock %}
{% block content %}
<div class="paper-detail-page">
    <div class="back-button">
        <a href="/papers">â† ëª©ë¡ìœ¼ë¡œ</a>
    </div>
    
    <div id="paper-detail" class="paper-detail">
        <!-- JavaScriptë¡œ ë™ì  ìƒì„± -->
    </div>
    
    <div class="comments-section">
        <h2>ğŸ’¬ ëŒ“ê¸€ (<span id="comment-count">0</span>)</h2>
        
        <!-- ëŒ“ê¸€ ì‘ì„± í¼ -->
        <div class="comment-form">
            <input type="text" id="comment-author" placeholder="ì´ë¦„" required>
            <textarea id="comment-content" placeholder="ëŒ“ê¸€ì„ ì…ë ¥í•˜ì„¸ìš”..." rows="3" required></textarea>
            <button onclick="submitComment()" class="btn-submit">ëŒ“ê¸€ ì‘ì„±</button>
        </div>
        
        <!-- ëŒ“ê¸€ ëª©ë¡ -->
        <div id="comments-list" class="comments-list">
            <!-- JavaScriptë¡œ ë™ì  ìƒì„± -->
        </div>
    </div>
</div>

<style>
.paper-detail-page {
    padding: 2rem;
    background: #f5f5f5;
    min-height: 100vh;
    max-width: 900px;
    margin: 0 auto;
}

.back-button {
    margin-bottom: 1rem;
}

.back-button a {
    color: #667eea;
    text-decoration: none;
    font-weight: bold;
}

.back-button a:hover {
    text-decoration: underline;
}

.paper-detail {
    background: white;
    padding: 2rem;
    border-radius: 12px;
    box-shadow: 0 2px 12px rgba(0,0,0,0.1);
    margin-bottom: 2rem;
}

.paper-title {
    font-size: 2rem;
    font-weight: bold;
    color: #333;
    margin-bottom: 1rem;
}

.paper-meta {
    display: flex;
    gap: 1rem;
    margin-bottom: 1.5rem;
    color: #666;
    font-size: 0.9rem;
}

.paper-content {
    line-height: 1.8;
    color: #333;
    margin-bottom: 1.5rem;
    white-space: pre-wrap;
}

.paper-link {
    display: inline-block;
    padding: 0.8rem 1.5rem;
    background: #667eea;
    color: white;
    text-decoration: none;
    border-radius: 8px;
    font-weight: bold;
}

.paper-link:hover {
    background: #5568d3;
}

.comments-section {
    background: white;
    padding: 2rem;
    border-radius: 12px;
    box-shadow: 0 2px 12px rgba(0,0,0,0.1);
}

.comments-section h2 {
    color: #667eea;
    margin-bottom: 1.5rem;
}

.comment-form {
    display: flex;
    flex-direction: column;
    gap: 1rem;
    margin-bottom: 2rem;
    padding: 1.5rem;
    background: #f9f9f9;
    border-radius: 8px;
}

.comment-form input,
.comment-form textarea {
    padding: 0.8rem;
    border: 2px solid #e0e0e0;
    border-radius: 8px;
    font-size: 1rem;
}

.comment-form input:focus,
.comment-form textarea:focus {
    outline: none;
    border-color: #667eea;
}

.btn-submit {
    padding: 0.8rem 1.5rem;
    background: #667eea;
    color: white;
    border: none;
    border-radius: 8px;
    font-weight: bold;
    cursor: pointer;
    align-self: flex-end;
}

.btn-submit:hover {
    background: #5568d3;
}

.comments-list {
    display: flex;
    flex-direction: column;
    gap: 1rem;
}

.comment-item {
    padding: 1rem;
    background: #f9f9f9;
    border-radius: 8px;
    border-left: 4px solid #667eea;
}

.comment-header {
    display: flex;
    justify-content: space-between;
    margin-bottom: 0.5rem;
}

.comment-author {
    font-weight: bold;
    color: #333;
}

.comment-date {
    color: #999;
    font-size: 0.9rem;
}

.comment-content {
    color: #666;
    line-height: 1.6;
    white-space: pre-wrap;
}

.empty-comments {
    text-align: center;
    color: #999;
    padding: 2rem;
}
</style>

<script>
const paperId = {{ paper_id }};

document.addEventListener('DOMContentLoaded', function() {
    loadPaper();
    loadComments();
});

function loadPaper() {
    fetch(`/api/papers/${paperId}`)
        .then(res => res.json())
        .then(paper => {
            const detailEl = document.getElementById('paper-detail');
            detailEl.innerHTML = `
                <h1 class="paper-title">${escapeHtml(paper.title)}</h1>
                <div class="paper-meta">
                    <span>ğŸ“ ${escapeHtml(paper.author || 'ìµëª…')}</span>
                    <span>ğŸ“… ${formatDate(paper.created_at)}</span>
                </div>
                ${paper.content ? `<div class="paper-content">${escapeHtml(paper.content)}</div>` : ''}
                ${paper.link ? `<a href="${escapeHtml(paper.link)}" target="_blank" class="paper-link">ğŸ”— ë…¼ë¬¸ ì›ë¬¸ ë³´ê¸°</a>` : ''}
            `;
        })
        .catch(err => console.error('[ERROR] ë…¼ë¬¸ ë¡œë“œ ì‹¤íŒ¨:', err));
}

function loadComments() {
    fetch(`/api/papers/${paperId}/comments`)
        .then(res => res.json())
        .then(comments => {
            const listEl = document.getElementById('comments-list');
            const countEl = document.getElementById('comment-count');
            
            countEl.textContent = comments.length;
            
            if (comments.length === 0) {
                listEl.innerHTML = '<div class="empty-comments">ì•„ì§ ëŒ“ê¸€ì´ ì—†ìŠµë‹ˆë‹¤. ì²« ëŒ“ê¸€ì„ ë‚¨ê²¨ë³´ì„¸ìš”!</div>';
                return;
            }
            
            listEl.innerHTML = comments.map(comment => `
                <div class="comment-item">
                    <div class="comment-header">
                        <span class="comment-author">${escapeHtml(comment.author)}</span>
                        <span class="comment-date">${formatDate(comment.created_at)}</span>
                    </div>
                    <div class="comment-content">${escapeHtml(comment.content)}</div>
                </div>
            `).join('');
        })
        .catch(err => console.error('[ERROR] ëŒ“ê¸€ ë¡œë“œ ì‹¤íŒ¨:', err));
}

function submitComment() {
    const author = document.getElementById('comment-author').value;
    const content = document.getElementById('comment-content').value;
    
    if (!author || !content) {
        alert('ì´ë¦„ê³¼ ëŒ“ê¸€ ë‚´ìš©ì„ ì…ë ¥í•´ì£¼ì„¸ìš”!');
        return;
    }
    
    fetch(`/api/papers/${paperId}/comments`, {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
        },
        body: JSON.stringify({ author, content })
    })
    .then(res => res.json())
    .then(data => {
        if (data.success) {
            document.getElementById('comment-author').value = '';
            document.getElementById('comment-content').value = '';
            loadComments();
        } else {
            alert('ì˜¤ë¥˜: ' + data.error);
        }
    })
    .catch(err => {
        console.error('[ERROR] ëŒ“ê¸€ ì‘ì„± ì‹¤íŒ¨:', err);
        alert('ëŒ“ê¸€ ì‘ì„±ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.');
    });
}

function formatDate(dateString) {
    const date = new Date(dateString);
    return date.toLocaleDateString('ko-KR', {
        year: 'numeric',
        month: 'long',
        day: 'numeric',
        hour: '2-digit',
        minute: '2-digit'
    });
}

function escapeHtml(text) {
    const div = document.createElement('div');
    div.textContent = text;
    return div.innerHTML;
}
</script>
{% endblock %}
